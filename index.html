<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>uppptip</title>
<!-- CDN –¥–ª—è ZIP -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
/*================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================*/
:root{
 --bg-main:#f5f7fa;--bg-grad:#c3cfe2;--bg-card:#fff;
 --bg-overlay:rgba(0,0,0,.5);--txt-main:#333;--txt-faded:#666;
 --accent:#007BFF;--border:#ddd;--row-alt:#f9fbff
}
body.dark{
 --bg-main:#1e1e1e;--bg-grad:#343a40;--bg-card:#2b2b2b;
 --bg-overlay:rgba(0,0,0,.7);--txt-main:#e9e9e9;--txt-faded:#aaa;
 --accent:#4dabff;--border:#444;--row-alt:#24292f
}
/*================== –°–ë–†–û–° / –û–ë–©–ï–ï ==================*/
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
html,body{height:100%}
body{background:linear-gradient(135deg,var(--bg-main) 0%,var(--bg-grad) 100%);color:var(--txt-main);transition:.3s}

/*================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==================*/
#authSection{display:flex;align-items:center;justify-content:center;min-height:100vh}
.auth-container{background:var(--bg-card);padding:25px 20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.2);width:320px;text-align:center;animation:fade .4s}
@keyframes fade{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.auth-tabs{display:flex;justify-content:center;align-items:center;margin-bottom:20px}
.auth-tab{font-size:1.1rem;color:var(--txt-faded);padding:5px 15px;cursor:pointer;transition:.3s}
.auth-tab.active{color:var(--accent);font-size:1.25rem;transform:scale(1.08)}
#toggleEmoji{margin:0 10px;font-size:1.5rem;cursor:pointer}
.auth-form-group{margin-bottom:14px;text-align:left}
.auth-form-group label{display:block;font-weight:600;margin-bottom:4px;font-size:.9rem}
.auth-form-group input{width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg-main);color:var(--txt-main)}
.auth-buttons button{background:var(--accent);color:#fff;border:none;padding:9px 0;width:100%;border-radius:4px;font-size:1rem;cursor:pointer;transition:.3s}
.auth-buttons button:hover{filter:brightness(.9)}

/*================== –•–ï–î–ï–† ==================*/
header{display:flex;justify-content:space-between;align-items:center;background:var(--bg-card);padding:13px 20px;box-shadow:0 2px 5px rgba(0,0,0,.15)}
.logo{font-size:1.35rem;font-weight:700;animation:pulse 3s infinite alternate}@keyframes pulse{to{color:var(--accent)}}
nav ul{list-style:none;display:flex;gap:18px;font-weight:500}
nav li{cursor:pointer;padding:4px 8px;border-radius:4px;transition:.25s}
nav li.active,nav li:hover{background:var(--accent);color:#fff}
.extra{display:flex;align-items:center;gap:14px}
.search-bar{display:flex;align-items:center;gap:6px}
.search-bar input{width:190px;padding:5px 9px;border:1px solid var(--border);border-radius:4px;background:var(--bg-card);color:var(--txt-main)}
.star-icon,.theme-toggle,.export-btn{font-size:1.3rem;cursor:pointer}
.star-icon.active{color:gold}
.profile-icon{width:42px;height:42px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s}
.profile-icon:hover{transform:scale(1.1);background:var(--txt-faded)}

/*================== –°–¢–†–ê–ù–ò–ß–ö–ò –≤ <main> ==================*/
main{flex:1;display:flex;flex-direction:column;align-items:center;padding:28px 20px}
.page{width:100%;max-width:1100px}

/*---- –ì–ª–∞–≤–Ω–∞—è ----*/
.hero{margin-bottom:30px;text-align:center}
.hero h2{font-size:1.8rem;margin-bottom:6px}
.fav-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:25px}

/*---- –°–æ–±—ã—Ç–∏—è ----*/
.event-add{display:flex;gap:8px;margin-bottom:16px}
.event-add input{padding:6px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg-card);color:var(--txt-main);flex:1}
.event-add button{background:var(--accent);color:#fff;border:none;padding:6px 14px;border-radius:4px;cursor:pointer}
.timeline{border-left:3px solid var(--accent);padding-left:14px;display:flex;flex-direction:column;gap:10px}
.timeline div{background:var(--bg-card);border:1px solid var(--border);border-left:4px solid var(--accent);padding:10px;border-radius:4px}

/*---- –û—Ç—á—ë—Ç—ã ----*/
.report-block{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:18px;margin-bottom:22px}
.report-block h3{margin-bottom:8px}
.stat-list{margin-bottom:18px}
.stat-list li{margin-bottom:4px}
.report-block button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}

/*---- –ö–µ–π—Å—ã ----*/
.tabs{display:flex;gap:14px;margin-bottom:22px;flex-wrap:wrap}
.tab-btn{padding:6px 14px;border:1px solid var(--border);border-radius:20px;background:var(--bg-card);cursor:pointer;font-size:.9rem;transition:.25s}
.tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:25px;width:100%}
.card{background:var(--bg-card);border:2px solid var(--border);border-radius:10px;height:140px;display:flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer;transition:.3s;text-align:center;padding:10px;font-size:1rem}
.card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 8px 18px rgba(0,0,0,.1)}
.card.fav{border-color:gold}

/*================== –ú–û–î–ê–õ–ö–ê ==================*/
.modal-overlay{display:none;position:fixed;inset:0;justify-content:center;align-items:center;background:var(--bg-overlay);backdrop-filter:blur(3px);z-index:1000}
.modal-content{background:var(--bg-card);width:92%;max-width:1000px;border-radius:8px;max-height:92vh;overflow:auto;animation:slide .3s}@keyframes slide{from{opacity:0;transform:translateY(-50px)}to{opacity:1}}
.close-modal{position:absolute;top:16px;right:18px;font-size:1.6rem;cursor:pointer;color:var(--txt-faded)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:var(--accent);color:#fff;border-radius:8px 8px 0 0}
.save-all{background:#fff;color:var(--accent);border:none;padding:4px 10px;border-radius:4px;font-size:.9rem;cursor:pointer}
.modal-body{padding:22px}
.step-row{display:grid;grid-template-columns:120px 1fr 1fr;gap:20px;margin-bottom:22px;padding:14px;border-radius:6px}
.step-row:nth-child(odd){background:var(--row-alt)}
@media(max-width:900px){.step-row{grid-template-columns:1fr}.step-circle{margin:0 auto 8px}}
.step-circle{width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid var(--accent);color:var(--accent);text-align:center;padding:10px;font-size:.9rem;background:var(--bg-card)}
.step-input,.example-textarea{width:100%;height:110px;border:1px solid var(--border);border-radius:4px;padding:10px;font-size:.9rem;resize:none;background:var(--bg-main);color:var(--txt-main)}
.example-column{display:flex;flex-direction:column;gap:6px}
.example-column label{font-size:.82rem;font-weight:700;color:var(--txt-faded)}
.download-circle{width:42px;height:42px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.25rem;cursor:pointer;transition:.3s}
.download-circle:hover{filter:brightness(.9);transform:scale(1.08)}

/*================== –¢–û–°–¢ ==================*/
.toast{position:fixed;bottom:18px;right:18px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:4px;opacity:0;pointer-events:none;transition:.4s}
.toast.show{opacity:1;pointer-events:auto}

/*================== –§–£–¢–ï–† ==================*/
footer{padding:18px 0;text-align:center;color:var(--txt-faded);font-size:.9rem}

/*================== –ö–ê–ë–ò–ù–ï–¢ ==================*/
#cabinetSection{display:none;min-height:100vh;padding:30px}
.cabinet-container{background:var(--bg-card);max-width:620px;margin:auto;padding:25px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
.cabinet-title{font-size:1.25rem;color:var(--accent);margin-bottom:20px;text-align:center}
.cabinet-profile{display:flex;flex-direction:column;align-items:center;margin-bottom:20px}
.cabinet-avatar-img{width:110px;height:110px;border-radius:50%;object-fit:cover;display:none}
.cabinet-avatar-emoji{font-size:70px;display:none}
.cabinet-username{font-weight:700;font-size:1.05rem;margin-top:6px}
.cabinet-actions{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:20px}
.cabinet-btn{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;font-size:.95rem}
.cabinet-settings-form{display:none}
.cabinet-form-group{margin-bottom:12px}
.cabinet-form-group input{width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg-main);color:var(--txt-main)}
.cabinet-save-btn{background:#28a745;color:#fff;border:none;padding:8px 14px;border-radius:4px;font-size:.95rem}
</style>
</head>
<body>
  <!-- ======= –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ======= -->
  <section id="authSection">
    <div class="auth-container">
      <div class="auth-tabs">
        <span class="auth-tab active" id="loginTab">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</span>
        <span id="toggleEmoji">‚áÜ</span>
        <span class="auth-tab" id="registerTab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
      </div>
      <div id="loginForm">
        <div class="auth-form-group"><label>–õ–æ–≥–∏–Ω</label><input id="loginUsername"></div>
        <div class="auth-form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="loginPassword"></div>
        <div class="auth-buttons"><button id="loginBtn">–í–æ–π—Ç–∏</button></div>
      </div>
      <div id="registerForm" style="display:none">
        <div class="auth-form-group"><label>–õ–æ–≥–∏–Ω</label><input id="regUsername"></div>
        <div class="auth-form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="regPassword"></div>
        <div class="auth-buttons"><button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
      </div>
    </div>
  </section>

  <!-- ======= –û–°–ù–û–í–ù–û–ô –°–ê–ô–¢ ======= -->
  <section id="siteWrapper" style="display:none;min-height:100vh;display:flex;flex-direction:column">
    <header>
      <div class="logo">uppptip</div>
      <nav>
        <ul>
          <li class="active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</li>
          <li data-page="events">–°–æ–±—ã—Ç–∏—è</li>
          <li data-page="reports">–û—Ç—á—ë—Ç—ã</li>
          <li data-page="cases">–ö–µ–π—Å—ã</li>
        </ul>
      </nav>
      <div class="extra">
        <div class="search-bar"><input id="searchInput" placeholder="–ü–æ–∏—Å–∫"><span class="star-icon" id="favToggle">‚≠ê</span></div>
        <span class="export-btn" id="exportBtn" title="–≠–∫—Å–ø–æ—Ä—Ç ZIP">üì¶</span>
        <span class="theme-toggle" id="themeToggle">üåû</span>
        <div class="profile-icon" id="profileIcon">üë§</div>
      </div>
    </header>

    <main>
      <!-- ---- –ì–ª–∞–≤–Ω–∞—è ---- -->
      <section id="pageHome" class="page">
        <div class="hero">
          <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã</h2>
          <p>–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>
        </div>
        <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
        <div class="fav-wrap" id="favWrap"></div>
      </section>

      <!-- ---- –°–æ–±—ã—Ç–∏—è ---- -->
      <section id="pageEvents" class="page" style="display:none">
        <h2 style="margin-bottom:18px">–°–æ–±—ã—Ç–∏—è / –õ–µ–Ω—Ç–∞</h2>
        <div class="event-add">
          <input id="eventInput" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ‚Ä¶">
          <button id="addEventBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="timeline" id="timeline"></div>
      </section>

      <!-- ---- –û—Ç—á—ë—Ç—ã ---- -->
      <section id="pageReports" class="page" style="display:none">
        <h2 style="margin-bottom:22px">–û—Ç—á—ë—Ç—ã</h2>
        <div class="report-block">
          <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
          <ul class="stat-list" id="statList"></ul>
          <button id="refreshStat">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="report-block">
          <h3>–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë</h3>
          <p style="margin-bottom:10px">–°–æ–±—Ä–∞—Ç—å –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ ZIP-–∞—Ä—Ö–∏–≤ –∏ —Å–∫–∞—á–∞—Ç—å.</p>
          <button id="exportBtn2">üì¶ –°–∫–∞—á–∞—Ç—å ZIP</button>
        </div>
      </section>

      <!-- ---- –ö–µ–π—Å—ã ---- -->
      <section id="pageCases" class="page" style="display:none">
        <div class="tabs">
          <button class="tab-btn active" data-cat="all">–í—Å–µ</button>
          <button class="tab-btn" data-cat="analitica">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
          <button class="tab-btn" data-cat="plan">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          <button class="tab-btn" data-cat="monitor">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
        </div>
        <div class="cards-grid" id="cardsGrid"></div>
      </section>
    </main>

    <footer>¬© 2025 uppptip</footer>
    <div id="modalsContainer"></div>
    <div id="toast" class="toast"></div>
  </section>

  <!-- ======= –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ======= -->
  <section id="cabinetSection">
    <div class="cabinet-container">
      <h2 class="cabinet-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
      <div class="cabinet-profile">
        <img id="cabinetAvatar" class="cabinet-avatar-img">
        <div id="cabinetEmoji" class="cabinet-avatar-emoji">üòÉ</div>
        <div class="cabinet-username" id="cabinetUsername"></div>
      </div>
      <div class="cabinet-actions">
        <button class="cabinet-btn" id="openSettingsBtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="cabinet-btn" id="backToMainBtn">–ù–∞–∑–∞–¥</button>
        <button class="cabinet-btn" id="logoutBtnCabinet">–í—ã–π—Ç–∏</button>
      </div>
      <div id="cabinetSettingsForm" class="cabinet-settings-form">
        <div class="cabinet-form-group"><label>–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω</label><input id="newUsername"></div>
        <div class="cabinet-form-group"><label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input type="password" id="newPassword"></div>
        <div class="cabinet-form-group"><label>–ù–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä</label><input type="file" id="avatarFile" accept="image/*"></div>
        <button class="cabinet-save-btn" id="saveSettingsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </section>

  <!-- ======= –°–ö–†–ò–ü–¢ ======= -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
  /* ---------- LS –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---------- */
  let users = JSON.parse(localStorage.getItem('users')) || [];
  let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
  let favCards = JSON.parse(localStorage.getItem('favCards')) || [];
  let events = JSON.parse(localStorage.getItem('events')) || [];
  let theme = localStorage.getItem('theme') || 'light';
  function saveLS(){
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    localStorage.setItem('favCards', JSON.stringify(favCards));
    localStorage.setItem('events', JSON.stringify(events));
  }

  /* ---------- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---------- */
  const authSection = document.getElementById('authSection');
  const siteWrapper = document.getElementById('siteWrapper');
  const cabinetSection = document.getElementById('cabinetSection');

  const loginTab = document.getElementById('loginTab'),
        registerTab = document.getElementById('registerTab'),
        toggleEmoji = document.getElementById('toggleEmoji');
  const loginForm = document.getElementById('loginForm'),
        registerForm = document.getElementById('registerForm');
  const loginUsername = document.getElementById('loginUsername'),
        loginPassword = document.getElementById('loginPassword');
  const regUsername = document.getElementById('regUsername'),
        regPassword = document.getElementById('regPassword');
  const loginBtn = document.getElementById('loginBtn'),
        registerBtn = document.getElementById('registerBtn');

  function updateView(){
    if(currentUser){
      authSection.style.display = 'none';
      siteWrapper.style.display = 'flex';
    } else {
      authSection.style.display = 'flex';
      siteWrapper.style.display = 'none';
    }
    cabinetSection.style.display = 'none';
  }
  updateView();

  function showLogin(){
    loginTab.classList.add('active');
    registerTab.classList.remove('active');
    loginForm.style.display = 'block';
    registerForm.style.display = 'none';
  }
  function showRegister(){
    registerTab.classList.add('active');
    loginTab.classList.remove('active');
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
  }
  loginTab.onclick = showLogin;
  registerTab.onclick = showRegister;
  toggleEmoji.onclick = () => {
    loginForm.style.display === 'block' ? showRegister() : showLogin();
  };

  loginBtn.onclick = () => {
    const u = loginUsername.value.trim(), p = loginPassword.value.trim();
    const me = users.find(x => x.username === u && x.password === p);
    if(me){
      currentUser = me;
      saveLS();
      updateView();
      initAfterLogin();
    } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å');
  };
  registerBtn.onclick = () => {
    const u = regUsername.value.trim(), p = regPassword.value.trim();
    if(!u || !p) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
    if(users.some(x => x.username === u)) return alert('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
    currentUser = { username: u, password: p, avatar: '' };
    users.push(currentUser);
    saveLS();
    updateView();
    initAfterLogin();
  };

  /* ---------- –ö–∞–±–∏–Ω–µ—Ç ---------- */
  const profileIcon = document.getElementById('profileIcon');
  const cabinetUsername = document.getElementById('cabinetUsername'),
        cabinetAvatar = document.getElementById('cabinetAvatar'),
        cabinetEmoji = document.getElementById('cabinetEmoji');
  const openSettingsBtn = document.getElementById('openSettingsBtn'),
        backToMainBtn = document.getElementById('backToMainBtn'),
        logoutBtnCabinet = document.getElementById('logoutBtnCabinet'),
        cabinetSettingsForm = document.getElementById('cabinetSettingsForm'),
        newUsername = document.getElementById('newUsername'),
        newPassword = document.getElementById('newPassword'),
        avatarFile = document.getElementById('avatarFile');

  function updAvatar(){
    if(currentUser?.avatar){
      cabinetAvatar.src = currentUser.avatar;
      cabinetAvatar.style.display = 'block';
      cabinetEmoji.style.display = 'none';
    } else {
      cabinetAvatar.style.display = 'none';
      cabinetEmoji.style.display = 'block';
    }
  }
  profileIcon.onclick = () => {
    if(!currentUser) return;
    cabinetUsername.textContent = currentUser.username;
    updAvatar();
    siteWrapper.style.display = 'none';
    cabinetSection.style.display = 'block';
  };
  backToMainBtn.onclick = () => {
    cabinetSection.style.display = 'none';
    siteWrapper.style.display = 'flex';
  };
  logoutBtnCabinet.onclick = () => {
    currentUser = null;
    saveLS();
    updateView();
  };

  openSettingsBtn.onclick = () => {
    cabinetSettingsForm.style.display =
      cabinetSettingsForm.style.display === 'block' ? 'none' : 'block';
  };
  document.getElementById('saveSettingsBtn').onclick = () => {
    if(!currentUser) return;
    const nu = newUsername.value.trim(),
          np = newPassword.value.trim();
    if(nu && nu !== currentUser.username){
      if(users.some(u=>u.username===nu)) return alert('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
      currentUser.username = nu;
    }
    if(np) currentUser.password = np;
    function finish(){
      saveLS(); updAvatar();
      cabinetUsername.textContent = currentUser.username;
      cabinetSettingsForm.style.display = 'none';
      newUsername.value = '';
      newPassword.value = '';
      avatarFile.value = '';
      alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }
    if(avatarFile.files[0]){
      const r = new FileReader();
      r.onload = e => {
        currentUser.avatar = e.target.result;
        finish();
      };
      r.readAsDataURL(avatarFile.files[0]);
    } else finish();
  };

  /* ---------- –¢–µ–º–∞ ---------- */
  function applyTheme(){
    document.body.classList.toggle('dark', theme==='dark');
    document.getElementById('themeToggle').textContent = theme==='dark' ? 'üåö' : 'üåû';
  }
  applyTheme();
  document.getElementById('themeToggle').onclick = () => {
    theme = theme==='dark' ? 'light' : 'dark';
    localStorage.setItem('theme', theme);
    applyTheme();
  };

  /* ---------- –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–µ–∫ ---------- */
  const cards = [
    {id:'swot',title:'SWOT-–∞–Ω–∞–ª–∏–∑',cat:'analitica',steps:['–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã','–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã','–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏','–£–≥—Ä–æ–∑—ã']},
    {id:'pest',title:'PEST-–∞–Ω–∞–ª–∏–∑',cat:'analitica',steps:['–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ','–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ','–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ','–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ']},
    {id:'porter',title:'5 —Å–∏–ª –ü–æ—Ä—Ç–µ—Ä–∞',cat:'analitica',steps:['–°–∏–ª–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤','–°–∏–ª–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π','–ù–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏','–ó–∞–º–µ–Ω–∏—Ç–µ–ª–∏','–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è']},
    {id:'lean',title:'Lean Canvas',cat:'plan',steps:['–ü—Ä–æ–±–ª–µ–º—ã','–°–µ–≥–º–µ–Ω—Ç—ã','–£–¢–ü','–†–µ—à–µ–Ω–∏–µ','–ö–∞–Ω–∞–ª—ã','–î–æ—Ö–æ–¥—ã','–ó–∞—Ç—Ä–∞—Ç—ã']},
    {id:'bmc',title:'Business Model Canvas',cat:'plan',steps:['–¶–ü','–ö–ª–∏–µ–Ω—Ç—ã','–ö–∞–Ω–∞–ª—ã','–û—Ç–Ω–æ—à–µ–Ω–∏—è','–î–æ—Ö–æ–¥—ã','–†–µ—Å—É—Ä—Å—ã','–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å','–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞—Ç—Ä–∞—Ç—ã']},
    {id:'vpc',title:'Value Proposition Canvas',cat:'plan',steps:['–ü—Ä–æ—Ñ–∏–ª—å','–ó–∞–¥–∞—á–∏','–ë–æ–ª–∏','–í—ã–≥–æ–¥—ã','–ü—Ä–æ–¥—É–∫—Ç','–£—Å—Ç—Ä–∞–Ω–∏—Ç–µ–ª–∏ –±–æ–ª–µ–π','–°–æ–∑–¥–∞—Ç–µ–ª–∏ –≤—ã–≥–æ–¥']},
    {id:'smart',title:'SMART-—Ü–µ–ª–∏',cat:'monitor',steps:['Specific','Measurable','Achievable','Relevant','Time-bound']},
    {id:'okr',title:'OKR-–ø–ª–∞–Ω',cat:'monitor',steps:['Objective','Key Result 1','Key Result 2','Key Result 3']},
    {id:'raci',title:'RACI-–º–∞—Ç—Ä–∏—Ü–∞',cat:'monitor',steps:['–ó–∞–¥–∞—á–∞','R','A','C','I']},
    {id:'kpi',title:'KPI-–¥–∞—à–±–æ—Ä–¥',cat:'monitor',steps:['–ú–µ—Ç—Ä–∏–∫–∞','–¢–µ–∫—É—â–∏–π','–¶–µ–ª—å','–ò—Å—Ç–æ—á–Ω–∏–∫']},
    {id:'risk',title:'–ú–∞—Ç—Ä–∏—Ü–∞ —Ä–∏—Å–∫–æ–≤',cat:'analitica',steps:['–†–∏—Å–∫','–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å','–í–ª–∏—è–Ω–∏–µ','–°—Ç—Ä–∞—Ç–µ–≥–∏—è']},
    {id:'stake',title:'–ö–∞—Ä—Ç–∞ —Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä–æ–≤',cat:'analitica',steps:['–°—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä','–ò–Ω—Ç–µ—Ä–µ—Å','–í–ª–∏—è–Ω–∏–µ','–°—Ç—Ä–∞—Ç–µ–≥–∏—è']},
    {id:'moscow',title:'MoSCoW-–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è',cat:'plan',steps:['Must','Should','Could','Won‚Äôt']},
    {id:'usm',title:'User Story Map',cat:'plan',steps:['–≠–ø–∏–∫–∏','–î–µ–π—Å—Ç–≤–∏—è','User Stories','–†–µ–ª–∏–∑—ã']},
    {id:'gantt',title:'–ì–∞–Ω—Ç—Ç-–¥–∏–∞–≥—Ä–∞–º–º–∞',cat:'plan',steps:['–ó–∞–¥–∞—á–∞','–ù–∞—á–∞–ª–æ','–ö–æ–Ω–µ—Ü','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π','%']},
    {id:'bsc',title:'Balanced Scorecard',cat:'monitor',steps:['–§–∏–Ω–∞–Ω—Å—ã','–ö–ª–∏–µ–Ω—Ç—ã','–ü—Ä–æ—Ü–µ—Å—Å—ã','–û–±—É—á–µ–Ω–∏–µ']}
  ];

  /* ---------- DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ---------- */
  const pages = {
    home: document.getElementById('pageHome'),
    events: document.getElementById('pageEvents'),
    reports: document.getElementById('pageReports'),
    cases: document.getElementById('pageCases')
  };
  const navItems = document.querySelectorAll('nav li');
  const cardsGrid = document.getElementById('cardsGrid'),
        favWrap = document.getElementById('favWrap'),
        timeline = document.getElementById('timeline'),
        toast = document.getElementById('toast'),
        searchInput = document.getElementById('searchInput'),
        favToggle = document.getElementById('favToggle');

  /* ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ---------- */
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),3000);
  }
  function roman(i){
    const r=['I','II','III','IV','V','VI','VII','VIII','IX','X'];
    return r[i]||i+1;
  }

  /* ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---------- */
  function showPage(key){
    Object.values(pages).forEach(p=>p.style.display='none');
    pages[key].style.display='block';
    navItems.forEach(li=>li.classList.toggle('active', li.dataset.page===key));
    if(key==='home') renderFav();
    if(key==='events') renderTimeline();
    if(key==='reports') updateStats();
  }
  navItems.forEach(li=>li.onclick=()=>showPage(li.dataset.page));

  /* ---------- –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ---------- */
  function buildCards(){
    cardsGrid.innerHTML = '';
    const filter = document.querySelector('.tab-btn.active').dataset.cat;
    const ordered = [...cards]
      .filter(c=>filter==='all'||c.cat===filter)
      .sort((a,b)=>(favCards.includes(a.id)?-1:1)+(favCards.includes(b.id)?1:-1));
    ordered.forEach(card=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.id = card.id;
      div.textContent = card.title;
      if(favCards.includes(card.id)) div.classList.add('fav');
      cardsGrid.appendChild(div);
      if(!document.getElementById('m_'+card.id)){
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'm_'+card.id;
        modal.innerHTML = `
          <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-header">
              <span>${card.title}</span>
              <button class="save-all" data-save="${card.id}">üíæ –°–∫–∞—á–∞—Ç—å –≤—Å—ë</button>
            </div>
            <div class="modal-body">
              ${card.steps.map((s,i)=>`
                <div class="step-row">
                  <div class="step-circle">${roman(i)}</div>
                  <textarea class="step-input" placeholder="${s}..." data-input="${card.id}_${i}"></textarea>
                  <div class="example-column">
                    <label>–ü—Ä–∏–º–µ—Ä</label>
                    <textarea class="example-textarea" placeholder="–ü—Ä–∏–º–µ—Ä: ${s.toLowerCase()}..." data-example="${card.id}_${i}"></textarea>
                    <div class="download-circle" data-dl="${card.id}_${i}">‚¨á</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>`;
        document.getElementById('modalsContainer').appendChild(modal);
      }
    });
    applySearch();
  }
  function renderFav(){
    favWrap.innerHTML = '';
    if(!favCards.length){
      favWrap.innerHTML = '<p style="grid-column:1/-1">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ ‚≠ê</p>';
      return;
    }
    favCards.forEach(id=>{
      const card = cards.find(c=>c.id===id);
      if(!card) return;
      const div = document.createElement('div');
      div.className = 'card fav';
      div.dataset.id = id;
      div.textContent = card.title;
      favWrap.appendChild(div);
    });
  }
  document.querySelectorAll('.tab-btn').forEach(b=>b.onclick=()=>{
    document.querySelector('.tab-btn.active').classList.remove('active');
    b.classList.add('active');
    buildCards();
  });
  cardsGrid.onclick = cardClick;
  favWrap.onclick = cardClick;
  favToggle.onclick = ()=>{
    favToggle.classList.toggle('active');
    if(favToggle.classList.contains('active'))
      showToast('–ö–ª–∏–∫–Ω–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
  };
  function cardClick(e){
    const c = e.target.closest('.card');
    if(!c) return;
    if(favToggle.classList.contains('active')){
      const id = c.dataset.id;
      if(favCards.includes(id)) favCards = favCards.filter(x=>x!==id);
      else favCards.push(id);
      saveLS(); buildCards(); renderFav();
      return;
    }
    openModal(c.dataset.id);
  }
  function applySearch(){
    const q = searchInput.value.toLowerCase();
    document.querySelectorAll('#cardsGrid .card').forEach(c=>{
      c.style.display = c.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
    });
  }
  searchInput.oninput = applySearch;

  /* ---------- –ú–æ–¥–∞–ª–∫–∏ ---------- */
  function openModal(id){
    const m = document.getElementById('m_'+id);
    m.style.display = 'flex';
    m.querySelectorAll('textarea').forEach(t=>{
      const key = (currentUser?.username||'guest')+'_'+
        (t.dataset.input?`in_${t.dataset.input}`:`ex_${t.dataset.example}`);
      t.value = localStorage.getItem(key) || '';
    });
  }
  document.getElementById('modalsContainer').onclick = e=>{
    if(e.target.classList.contains('modal-overlay'))
      e.target.style.display = 'none';
    if(e.target.classList.contains('close-modal'))
      e.target.closest('.modal-overlay').style.display = 'none';
    if(e.target.dataset.dl){
      const [cid, idx] = e.target.dataset.dl.split('_');
      const step = cards.find(c=>c.id===cid).steps[idx];
      const txt = document.querySelector(`[data-example="${cid}_${idx}"]`).value;
      download(`${cid}_${idx}.txt`, `${step}:\n${txt}`);
    }
    if(e.target.dataset.save){
      saveAll(e.target.dataset.save);
    }
  };
  document.getElementById('modalsContainer').addEventListener('input', e=>{
    if(!e.target.matches('textarea')) return;
    const t = e.target;
    const key = (currentUser?.username||'guest')+'_'+
      (t.dataset.input?`in_${t.dataset.input}`:`ex_${t.dataset.example}`);
    localStorage.setItem(key, t.value);
  });
  function saveAll(cid){
    const card = cards.find(c=>c.id===cid);
    let txt = `${card.title}\n========================\n`;
    card.steps.forEach((s,i)=>{
      const inV = document.querySelector(`[data-input="${cid}_${i}"]`).value;
      const exV = document.querySelector(`[data-example="${cid}_${i}"]`).value;
      txt += `‚Ä¢ ${s}\n–ü–æ–ª–µ: ${inV}\n–ü—Ä–∏–º–µ—Ä: ${exV}\n\n`;
    });
    download(`${cid}.txt`, txt);
  }

  /* ---------- –°–æ–±—ã—Ç–∏—è ---------- */
  function renderTimeline(){
    timeline.innerHTML = events.map(ev=>
      `<div><strong>${ev.date}</strong><br>${ev.text}</div>`
    ).join('');
  }
  document.getElementById('addEventBtn').onclick = ()=>{
    const val = document.getElementById('eventInput').value.trim();
    if(!val) return;
    events.unshift({date: new Date().toLocaleString(), text: val});
    document.getElementById('eventInput').value = '';
    saveLS(); renderTimeline();
  };

  /* ---------- –û—Ç—á—ë—Ç—ã ---------- */
  function countFilled(card){
    let filled = 0;
    card.steps.forEach((_,i)=>{
      if(localStorage.getItem(`${currentUser?.username||'guest'}_in_${card.id}_${i}`)) filled++;
    });
    return filled;
  }
  function updateStats(){
    const ul = document.getElementById('statList');
    ul.innerHTML = '';
    cards.forEach(c=>{
      const f = countFilled(c);
      ul.innerHTML += `<li>${c.title}: –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ${f}/${c.steps.length}</li>`;
    });
  }
  document.getElementById('refreshStat').onclick = updateStats;

  /* ---------- ZIP-—ç–∫—Å–ø–æ—Ä—Ç ---------- */
  function download(name, content){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type:'text/plain'}));
    a.download = name; a.click();
    URL.revokeObjectURL(a.href);
  }
  async function exportZIP(){
    const zip = new JSZip(), uname = currentUser?.username||'guest';
    cards.forEach(card=>{
      let txt = `${card.title}\n========================\n`;
      card.steps.forEach((s,i)=>{
        const inV = localStorage.getItem(`${uname}_in_${card.id}_${i}`)||'';
        const exV = localStorage.getItem(`${uname}_ex_${card.id}_${i}`)||'';
        txt += `‚Ä¢ ${s}\n–ü–æ–ª–µ: ${inV}\n–ü—Ä–∏–º–µ—Ä: ${exV}\n\n`;
      });
      zip.file(`${card.title}.txt`, txt);
    });
    const blob = await zip.generateAsync({type:'blob'});
    download('uppptip_export.zip', blob);
  }
  document.getElementById('exportBtn').onclick = exportZIP;
  document.getElementById('exportBtn2').onclick = exportZIP;

  /* ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ ---------- */
  function initAfterLogin(){
    buildCards();
    renderFav();
    renderTimeline();
    updateStats();
  }
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –µ—Å–ª–∏ –≤–æ—à–ª–∏ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
  showPage('home');
  if(currentUser) initAfterLogin();
  </script>
</body>
</html>
